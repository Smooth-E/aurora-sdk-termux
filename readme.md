# Аврора SDK внутри Termux

В этой статье расписано, как установить SDK Аврора ОС и собрать ваше первое приложение, используя устройство на Android. Описанный способ - самый прямолинейный и оттого очень медленный. Сборка проекта-шаблона ApplicationTemplate на процессоре Snapdragon 7+ Gen 2 занимает 5 минут 25 секунд. Для установки вам потребуется около 10 GB свободного места на устройстве, стабильное интернет-соединение и несколько часов свободного времени.

Часть статьи основана на https://github.com/cyberkernelofficial/docker-in-termux

## Установка Aurora Platform SDK внутри ВМ Qemu с Alpine Linux

1. Начнем. Для начала установите мобильное приложение Termux [из магазина F-Droid](https://f-droid.org/packages/com.termux/) или со [страницы GitHub Releases](https://github.com/termux/termux-app/releases).
2. Откройте Termux, предоставьте все необходимые разрешения.
3. Выберите наиболее близкое к вам или вашему провайдеру зеркало для обновления пакетной базы Termux. Выполните следующую команду, ставьте флажки-галочки нажимая на пробел, подтверждайте выделение клавишей Enter.
```sh
termux-change-repo
```
4. Обновите пакетную базу Termux
```sh
pkg up -y
```
5. Установите необходимые зависимости для запуска эмулятора Qemu и для скачивания нужных файлов
```sh
pkg install qemu-utils qemu-common qemu-system-x86_64-headless wget git -y
```
6. Клонируйте этот репозиторий и перейдите в соответствующую папку
```sh
git clone https://github.com/Smooth-E/aurora-sdk-termux.git && cd aurora-sdk-termux
```
7. Скачайте образ Alpine Linux для виртуальных машин при помощи wget. Вы можете скопировать ссылку на последнюю версию образа, перейдя в браузере на официальный сайт.
```sh
wget http://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-virt-3.20.2-x86_64.iso
```
8. Создайте образ диска для виртуальной машины. Учтите, что файлы Аврора SDK занимают примерно 10 GB. Файл-образ растет пропорционально заполнению виртуального диска, так что его изначальный размер примерно 500 Mb. Команда ниже создаст файл `alpine,qcow2`, который сможет увеличиться до 40 GB, если это потребуется.
```sh
qemu-img create -f qcow2 alpine.qcow2 40G
```
9. Запустим виртуальную машину. Для параметра `-m` укажите количество оперативной памяти для виртуальной машины. Рекомендую выделить ВМ где-то 70% оперативной памяти вашего устройства. Если имя скачанного вами установочного образа Alpine отличается - исправьте параметр `-cdrom`.
```sh
qemu-system-x86_64 -machine q35 -smp cpus=$(nproc) -cpu qemu64 -drive if=pflash,format=raw,read-only=on,file=$PREFIX/share/qemu/edk2-x86_64-code.fd -netdev user,id=n1,dns=8.8.8.8,hostfwd=tcp::2222-:22 -device virtio-net,netdev=n1 -cdrom alpine-virt-3.20.2-x86_64.iso -nographic -m 6000 alpine.qcow2
```
10.  Войдите в лайв-систему с логином `root` (без пароля).
11.  Выполните следующую команду, чтобы включить поддержку сети. Нажимайте Enter, чтобы использовать параметры по умолчанию.
```sh
setup-interfaces
```
12. Включите сетевой интерфейс eth0 (или тот, что вы выбрали до этого).
```sh
ifup eth0
```
13. Скачайте вспомогательный файл `setup-opts`.
```sh
wget https://raw.githubusercontent.com/cyberkernelofficial/docker-in-termux/main/answerfile
```
> Если во время скачивания вы получили ошибку на подобии `wget: bad address 'gist.githubusercontent.com'`, запустите следующую команду и попробуйте еще раз.
> ```sh
> echo -e "nameserver 192.168.1.1\nnameserver 1.1.1.1" > /etc/resolv.conf
> ```
14. Измените скрипт `/sbin/setup-disk`, чтобы включить вывод в серийную консоль во время запуска установленной системы.
```sh
sed -i -E 's/(local kernel_opts)=.*/\1="console=ttyS0"/' /sbin/setup-disk
```
15.  Установите Alpine на диск виртуальной машины.
```sh
setup-alpine -f setup-opts
```
16.  После завершения установки выключите виртуальную машину
```sh
poweroff
```
17.  Сохраним команду для запуска виртуальной машины в файл `start.sh` для удобства. Не забудьте изменить значение параметра `-m`.
```sh
echo "qemu-system-x86_64 -machine q35 -smp cpus=$(nproc) -cpu qemu64 -drive if=pflash,format=raw,read-only=on,file=$PREFIX/share/qemu/edk2-x86_64-code.fd -netdev user,id=n1,dns=8.8.8.8,hostfwd=tcp::2222-:22 -device virtio-net,netdev=n1 -nographic -m 6000 alpine.qcow2" > start.sh && chmod +x start.sh
```
18.  Запустите виртуальную машину с Alpine, используя скрипт. Учтите, что запуск виртуальной машины занимает несколько минут. После запуска вы увидите приглашение войти в систему.
```sh
./start.sh
```
19.  Установите пакеты необходимые для работы скрипта-установщика.
```sh
apk add bash sudo nano coreutils util-linux tar git
```
20.   Создайте нового пользователя. В этой статье пользователь будет иметь име `user`. 
```sh
setup-user
```
21.  Добавьте пользователя в группу `wheel`.
```sh
adduser user wheel
```
22.  Настройте работу пользователя с `sudo`. Эта команда также выключит запрос пароля при активации `sudo`. Это очень поможет, так как установка SDK занимает несколько часов и полностью останавливается, если вовремя не ввести пароль. После выключения запроса пароля командой ниже, установку можно будет оставить без наблюдения.
```sh
echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel
```
23.  Выйдите из сессии командой `exit` а потом войдите, как новый пользователь.
24.  Скачайте архив с установочным скриптом Aurora PSDK.
```sh
wget https://sdk-repo.omprussia.ru/sdk/documents/Platform_SDK/CI/psdk_install-master.zip
```
25.  Распакуйте архив и перейдите в новую папку
```sh
unzip psdk_install-master.zip && cd psdk_install-master
```
26.  Далее очень важно правильно составить команду для установки. В первую очередь стоит выбрать релиз SDK. Список доступных релизов можно [посмотреть по ссылке](https://sdk-repo.omprussia.ru/sdk/installers/).
    - Для примера возьмем релиз 5.1.5.105. Установщик для этой версии находится по пути `/installers/5.1.5/5.1.5.105-release/AuroraPSDK`. Некоторые релизы могут иметь другую структуру папок. Таким образом параметр `--input-url` для скрипта-установщика для установки конкретно релиза 5.1.5.105 будет выглядеть так
    ```
    --input-url /installers/5.1.5/5.1.5.105-release/AuroraPSDK
    ```
    - Далее стоит определить значение параметра `--toolchain-suffix`. Перейдя по ссылке input-url посмотрите на имена расположенных там фалов. Буквы после `Aurora_OS-<release>-` и до `-Aurora_Platform_SDK_Chroot-x86_64.tar.xz` - и есть суффикс имени тулчейна. Например, для 5.1.5.105 использован суффикс `MB2`.
    - Параметр `--install-dir` определяет директорию установки SDK. Укажите абсолютный путь до папки в директории home вашего пользователя. Для примера укажем `~/AuroraPSDK`.
    - Если во время установки возникают ошибки проверки контрольных сумм, добавьте параметр `--ignore-md5-checks`.
    - Наконец, выберите архитектуры, под которые собираетесь компилировать приложения. Для быстроты установки укажем всего одну архитектуру `aarch64`.
    - Вы можете подробнее почитать об этих и других опциях, запустив скрипт без аргументов.

Для правильной работы скрипта, его следует запустить внутри bash.
```sh
bash ./install_aurora_psdk.sh --input-url https://sdk-repo.omprussia.ru/sdk/installers/5.1.5/5.1.5.105-release/AuroraPSDK --toolchain-suffix MB2 --install-dir ~/AuroraPSDK --ignore-md5-checks --allowed-targets aarch64
```

Установка SDK в виртуальной машине занимает несколько часов. Во время установки следует поддерживать стабильное интернет-соединение, рекомендуется держать приложение Termux открытым (периодически можно сворачивать, но не желательно), использовать VPN нельзя. Во время установки (если настроено `sudo` без пароля) никаких действий не требуется.

## Проверка работоспособности

1. Клонируйте репозиторий с шаблоном приложения для ОС Аврора.
```bash
git clone https://gitlab.com/omprussia/demos/ApplicationTemplate
```
2. Перейдите в папку с проектом, а затем запустите сборку следующей командой.
```bash
~/AuroraPSDK/sdks/aurora_psdk/sdk-chroot mb2 -t AuroraOS-5.1.5.105-MB2-aarch64 -x build
```

Ознакомиться с основами работы с Platform SDK ОС Аврора можно на официальном сайте: https://developer.auroraos.ru/doc/sdk/psdk
